<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Ed-Fi Data Import Tool</title>
		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
<link rel="stylesheet" href="dist/theme/white.css" id="theme">
		<!-- Theme used for syntax highlighted code -->
<link rel="stylesheet" href="plugin/highlight/zenburn.min.css" id="highlight-theme"></head>
	<body>
		<div class="reveal">
			<div class="slides">
<section data-markdown  data-auto-animate><textarea data-template>
[comment]: # (markdown: { smartypants: true })



Data into Ed-Fi with<br /><code style="color:#007978;">earthmover</code> + <code style="color:#1c5ca7;">lightbeam</code>

<hr style="border-width:1px 0 0 0;" />

<div style="font-size:26px; line-height:56px;"><strong>Tom Reitz</strong> &nbsp; &nbsp; Data Engineer @ <img src="media/ea_logo.png" style="height:48px; width:auto; margin:0; padding:0 10px; vertical-align:middle;" /></div>



</textarea></section>
<section data-markdown  data-auto-animate><textarea data-template>

### Ed-Fi Data Import Tool
* imports data from flat files                             <!-- .element: class="fragment" data-fragment-index="2" -->
* requires a map (columns &rarr; Ed-Fi resources, fields)  <!-- .element: class="fragment" data-fragment-index="3" -->
* mappings exist for several assessments                   <!-- .element: class="fragment" data-fragment-index="4" -->
* complex data transformations cannot be done in the tool (requires Powershell script, SQL, etc.)  <!-- .element: class="fragment" data-fragment-index="5" -->
* UI-based import makes automation difficult               <!-- .element: class="fragment" data-fragment-index="6" -->



</textarea></section>
<section data-markdown  data-auto-animate><textarea data-template>

### Instead: <code style="color:#007978;">earthmover</code> + <code style="color:#1c5ca7;">lightbeam</code>



</textarea></section>
<section data-markdown  data-auto-animate><textarea data-template>

### <code style="color:#007978;">earthmover</code>
* a Python CLI tool  <!-- .element: class="fragment" data-fragment-index="2" -->
* constructs Ed-Fi JSON from flat files based on a YAML configuration  <!-- .element: class="fragment" data-fragment-index="3" -->
* supports transformations like join, filter, distinct, group by, and more  <!-- .element: class="fragment" data-fragment-index="4" -->
* a JSON template is rendered for each row of transformed data  <!-- .element: class="fragment" data-fragment-index="5" -->



</textarea></section>
<section data-markdown  data-auto-animate data-background-color="#007978"><textarea data-template>

### <code style="color:#FFF;">earthmover</code> configuration
```yaml  [|4-10|12-21|23-34]
config:
  output_dir: ./

sources:
  courses:
    file: ./data/Courses.csv
    header_rows: 1
  schools:
    file: ./data/Schools.csv
    header_rows: 1

transformations:
  courses:
    - operations: join
      sources:
        - $sources.courses
        - $sources.schools
      join_type: inner
      left_key: school_id
      right_key: school_id
    ...

destinations:
  # a destination for each Ed-Fi resource and descriptor
  schools:
    source: $sources.schools
    template: ./json_templates/school.jsont
    extension: jsonl
    linearize: True
  courses:
    source: $transformations.courses
    template: ./json_templates/course.jsont
    extension: jsonl
    linearize: True
```



</textarea></section>
<section data-markdown  data-background-color="#007978"><textarea data-template>

### <code style="color:#FFF;">earthmover</code> template
```json [|2|18-20]
{
  "courseCode": "{{course_code}}",
  "identificationCodes": [
    {
      "courseIdentificationSystemDescriptor": "uri://ed-fi.org/CourseIdentificationSystemDescriptor#LEA course code",
      "identificationCode": "{{course_code}}"
    }
  ],
  "educationOrganizationReference": {
    "educationOrganizationId": {{district_id}}
  },
  "academicSubjectDescriptor": "uri://ed-fi.org/AcademicSubjectDescriptor#{{academic_subject}}",
  "courseDefinedByDescriptor": "uri://ed-fi.org/CourseDefinedByDescriptor#LEA",
  "courseDescription": "{{course_name}}",
  "courseGPAApplicabilityDescriptor": "uri://ed-fi.org/CourseGPAApplicabilityDescriptor#{{gpa_weight}}",
  "courseTitle": "{{course_name}}",
  "levelCharacteristics": [
    {% if is_ap==1 %}
    { ... }
    {% endif %}
  ],
  "numberOfParts": 1
  "offeredGradeLevels": [
    ...
  ]
}
```
<small>JSON + Jinja templating languge</small>



</textarea></section>
<section data-markdown  data-auto-animate><textarea data-template>

### <code style="color:#1c5ca7;">lightbeam</code>
* also a Python CLI tool                            <!-- .element: class="fragment" data-fragment-index="2" -->
* processes JSONL files                             <!-- .element: class="fragment" data-fragment-index="3" -->
* validates JSON based on Ed-Fi API's Swagger docs  <!-- .element: class="fragment" data-fragment-index="4" -->
* sends JSON to an Ed-Fi API in dependency-order    <!-- .element: class="fragment" data-fragment-index="5" -->



</textarea></section>
<section data-markdown  data-auto-animate data-background-color="#1c5ca7"><textarea data-template>

### <code style="color:#FFF;">lightbeam</code> configuration
```yaml  [|1|2|3-9|8-9|10-16]
data_dir: ./
validate: True
edfi_api:
  base_url: https://api.schooldistrict.org/v5.3/api
  version: 3
  mode: year_specific
  year: 2021
  client_id: ${EDFI_API_CLIENT_ID}
  client_secret: ${${EDFI_API_CLIENT_SECRET}
connection:
  pool_size: 8
  timeout: 60
  num_retries: 10
  backoff_factor: 1.5
  retry_statuses: [429, 500, 502, 503, 504]
  verify_ssl: True
```<!-- .element: class="fragment" data-fragment-index="2" -->



</textarea></section>
<section data-markdown  data-auto-animate data-background-color="#cbdc3f"><textarea data-template>

Putting it all together

```bash
earthmover path/to/config.yaml
lightbeam path/to/config.yaml
```


</textarea></section>
<section data-markdown  data-auto-animate><textarea data-template>

### Features
* <code style="color:#007978;">earthmover</code> visualizes data lineage
![media/dag.png](media/dag.png)

</textarea></section>
<section>
<section data-markdown  data-auto-animate><textarea data-template>

### Features
* selectors: process only some descriptors/resources
  ```bash
  earthmover path/to/config.yaml -s courses,student*
  lightbeam path/to/config.yaml -s courses,student*
  ```

</textarea></section>
<section data-markdown  data-auto-animate><textarea data-template>

### Features
* use environment variables or command-line parameters (which override env vars)
  ```bash
  earthmover path/to/config.yaml -p '{\
  "BASE_DIR":"path/to/base/dir"\
  }'

  lightbeam path/to/config.yaml -p '{\
  "CLIENT_ID":"populated",\
  "CLIENT_SECRET":"populatedSecret"\
  }'
  ```

</textarea></section>
<section data-markdown  data-auto-animate><textarea data-template>

### Features
* <code style="color:#007978;">earthmover</code> state tracking: only reprocess if source files changed (based on file hash)
  ```yaml
  # earthmover
  config:
    state_file: ~/.earthmover.csv
  ```

</textarea></section>
<section data-markdown  data-auto-animate><textarea data-template>

### Features
* <code style="color:#1c5ca7;">lightbeam</code> state tracking: selectively resend payloads
  ```yaml
  # lightbeam
  state_dir: ~/.lighbeam/
  ```

  ```bash
  lightbeam path/to/config.yaml --newer-than 2020-12-25T00:00:00
  ```

</textarea></section>
<section data-markdown  ><textarea data-template>

### Features
* <code style="color:#007978;">earthmover</code> supports source files larger than memory (via chunking)
* tested with attendance data of 2GB+



</textarea></section>
</section>
<section data-markdown  ><textarea data-template>

<a href="https://github.com/edanalytics/earthmover" target="_blank" style="color:#007978;">earthmover</a> + <a href="https://github.com/edanalytics/lightbeam" target="_blank" style="color:#1c5ca7;">lightbeam</a> are currently<br />private GitHub repositories.

We plan to release them as open-source<br />(Apache 2.0 license) projects shortly.

Extensive docs and examples are available.

</textarea></section>
<section data-markdown  ><textarea data-template>

We've also translated ~20 existing Data Import Tool mappings for assessment data into reusable <a href="https://github.com/edanalytics/earthmover_edfi_bundles" target="_blank">earthmover Ed-Fi bundles</a> which will be open-sourced.

![media/earthmover-assessment-bundles.png](media/earthmover-assessment-bundles.png)



</textarea></section>
<section data-markdown ><textarea data-template>

### Conclusion

* EA is already using <code style="color:#007978;">earthmover</code> + <code style="color:#1c5ca7;">lightbeam</code>
* works nicely in data pipelines (Airflow, Dagster)
* most of the work is building the JSON templates and YAML transformations
* we're working with a partner to do custom mapping for flat data they have from a SIS they don't own
* other use-cases include
  - pre-populating Ed-Fi with custom descriptors
  - converting data to Ed-Fi for analytics without needing an Ed-Fi API/ODS
</textarea></section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script src="plugin/math/math.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
Reveal.initialize({
controls : false,
markdown : {smartypants: true},
controls : true,
keyboard : true,
hash : false,
respondToHashChanges : false,
				hash: true,
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealMath ]
			});
		</script>
	</body>
</html>
